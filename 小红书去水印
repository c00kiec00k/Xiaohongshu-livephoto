#import <UIKit/UIKit.h>

// 悬浮窗按钮
@interface FloatingButton : UIButton
@property (nonatomic, assign) CGPoint lastLocation;
@end

@implementation FloatingButton

- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
    self.lastLocation = self.center;
    [super touchesBegan:touches withEvent:event];
}

- (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event {
    UITouch *touch = [touches anyObject];
    CGPoint location = [touch locationInView:self.superview];
    CGPoint delta = CGPointMake(location.x - self.lastLocation.x, location.y - self.lastLocation.y);
    
    CGPoint newCenter = CGPointMake(self.center.x + delta.x, self.center.y + delta.y);
    self.center = newCenter;
    self.lastLocation = newCenter;
}

@end

// 设置面板
@interface SettingsPanel : UIView <UITableViewDelegate, UITableViewDelegate>
@property (nonatomic, strong) UITableView *tableView;
@property (nonatomic, strong) NSArray *options;
@end

@implementation SettingsPanel

- (instancetype)init {
    if (self = [super init]) {
        self.backgroundColor = [UIColor whiteColor];
        self.layer.cornerRadius = 15;
        self.layer.masksToBounds = YES;
        
        // 设置面板大小
        self.frame = CGRectMake(0, 0, 300, 400);
        self.center = [UIApplication sharedApplication].keyWindow.center;
        
        // 标题
        UILabel *titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(15, 10, 200, 20)];
        titleLabel.text = @"@c00kiec00k";
        titleLabel.textColor = [UIColor grayColor];
        titleLabel.font = [UIFont systemFontOfSize:10];
        [self addSubview:titleLabel];
        
        // 关闭按钮
        UIButton *closeButton = [UIButton buttonWithType:UIButtonTypeCustom];
        closeButton.frame = CGRectMake(self.frame.size.width - 40, 10, 30, 30);
        [closeButton setTitle:@"x" forState:UIControlStateNormal];
        [closeButton setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
        closeButton.titleLabel.font = [UIFont systemFontOfSize:12];
        [closeButton addTarget:self action:@selector(close) forControlEvents:UIControlEventTouchUpInside];
        [self addSubview:closeButton];
        
        // 设置选项
        self.options = @[
            @{@"title": @"去除底栏购物", @"key": @"remove_tab_shopping"},
            @{@"title": @"去除底栏加号", @"key": @"remove_tab_post"},
            @{@"title": @"去除所有水印", @"key": @"remove_save_watermark"},
            @{@"title": @"强制保存媒体", @"key": @"force_save_media"}
        ];
        
        // 表格视图
        self.tableView = [[UITableView alloc] initWithFrame:CGRectMake(0, 50, self.frame.size.width, self.frame.size.height - 100) style:UITableViewStylePlain];
        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        self.tableView.scrollEnabled = YES;
        self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        [self addSubview:self.tableView];
        
        // 底部文字
        UILabel *bottomLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, self.frame.size.height - 40, self.frame.size.width, 30)];
        bottomLabel.numberOfLines = 2;
        bottomLabel.textAlignment = NSTextAlignmentCenter;
        bottomLabel.textColor = [UIColor lightGrayColor];
        bottomLabel.font = [UIFont systemFontOfSize:8];
        bottomLabel.text = @"𝗗𝗲𝘃𝗲𝗹𝗼𝗽𝗲𝗱 𝗯𝘆 @维他入我心\n𝗠𝗼𝗱𝗶𝗳𝗶𝗲𝗱 𝗯𝘆 @𝗰𝟬𝟬𝗸𝗶𝗲𝗰𝟬𝟬𝗸";
        [self addSubview:bottomLabel];
    }
    return self;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.options.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    static NSString *cellId = @"Cell";
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellId];
    
    if (!cell) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:cellId];
        cell.textLabel.textAlignment = NSTextAlignmentCenter;
        cell.textLabel.textColor = [UIColor grayColor];
        cell.textLabel.font = [UIFont systemFontOfSize:12];
        
        UISwitch *switchView = [[UISwitch alloc] init];
        [switchView addTarget:self action:@selector(switchChanged:) forControlEvents:UIControlEventValueChanged];
        cell.accessoryView = switchView;
    }
    
    NSDictionary *option = self.options[indexPath.row];
    cell.textLabel.text = option[@"title"];
    ((UISwitch *)cell.accessoryView).on = [[NSUserDefaults standardUserDefaults] boolForKey:option[@"key"]];
    
    return cell;
}

- (void)switchChanged:(UISwitch *)sender {
    UITableViewCell *cell = (UITableViewCell *)sender.superview;
    NSIndexPath *indexPath = [self.tableView indexPathForCell:cell];
    NSDictionary *option = self.options[indexPath.row];
    
    [[NSUserDefaults standardUserDefaults] setBool:sender.isOn forKey:option[@"key"]];
    [[NSUserDefaults standardUserDefaults] synchronize];
}

- (void)close {
    [self removeFromSuperview];
}

@end

// Hook 主要类
%hook SpringBoard

- (void)applicationDidFinishLaunching:(id)application {
    %orig;
    
    // 创建悬浮按钮
    FloatingButton *floatingButton = [FloatingButton buttonWithType:UIButtonTypeCustom];
    floatingButton.frame = CGRectMake(0, 0, 40, 40);
    floatingButton.center = [UIScreen mainScreen].bounds.size.width / 2;
    [floatingButton setTitle:@"logo" forState:UIControlStateNormal];
    floatingButton.backgroundColor = [UIColor colorWithWhite:0 alpha:0.7];
    floatingButton.layer.cornerRadius = 20;
    
    // 添加长按手势
    UILongPressGestureRecognizer *longPress = [[UILongPressGestureRecognizer alloc] initWithTarget:self action:@selector(showSettings:)];
    [floatingButton addGestureRecognizer:longPress];
    
    // 添加三指双击手势
    UITapGestureRecognizer *tripleTap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(toggleFloatingButton:)];
    tripleTap.numberOfTouchesRequired = 3;
    tripleTap.numberOfTapsRequired = 2;
    [[UIApplication sharedApplication].keyWindow addGestureRecognizer:tripleTap];
    
    [[UIApplication sharedApplication].keyWindow addSubview:floatingButton];
}

%new
- (void)showSettings:(UILongPressGestureRecognizer *)gesture {
    if (gesture.state == UIGestureRecognizerStateBegan) {
        SettingsPanel *panel = [[SettingsPanel alloc] init];
        [[UIApplication sharedApplication].keyWindow addSubview:panel];
    }
}

%new
- (void)toggleFloatingButton:(UITapGestureRecognizer *)gesture {
    FloatingButton *button = [UIApplication sharedApplication].keyWindow.subviews.lastObject;
    if ([button isKindOfClass:[FloatingButton class]]) {
        button.hidden = !button.hidden;
    }
}

%end
