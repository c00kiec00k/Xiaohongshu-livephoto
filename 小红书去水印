/**
 * XhsPlus - 小红书增强插件
 * 适用环境：iPhone 12, iOS 16.0.2, 未越狱
 * 开发工具：MonkeyDev
 */

#import <UIKit/UIKit.h>
#import <objc/runtime.h>

#pragma mark - 类声明

// 小红书原生类声明
@interface XHSAppDelegate : UIResponder <UIApplicationDelegate>
@end

@interface XYTabBar : UIView
@property (nonatomic, strong) NSArray *subviews;
@end

@interface XYPHMediaSaveConfig : NSObject
- (void)setDisableWatermark:(_Bool)arg1;
- (void)setDisableSave:(_Bool)arg1;
@end

#pragma mark - 自定义类声明

// 悬浮按钮
@interface FloatingButton : UIButton
- (void)setBase64Image:(NSString *)base64String;
@end

// 控制面板
@interface ControlPanel : UIView {
    NSMutableArray *_sectionViews;
    UIScrollView *_scrollView;
}
- (void)setupUI;
@end

#pragma mark - 全局变量

static FloatingButton *floatingButton;
static ControlPanel *controlPanel;
static BOOL isButtonVisible = YES;

#pragma mark - 工具方法

// 获取当前的KeyWindow
static UIWindow* getKeyWindow() {
    UIWindow *keyWindow = nil;
    if (@available(iOS 13.0, *)) {
        for (UIWindowScene *scene in UIApplication.sharedApplication.connectedScenes) {
            if (scene.activationState == UISceneActivationStateForegroundActive) {
                keyWindow = scene.windows.firstObject;
                break;
            }
        }
    } else {
        keyWindow = [UIApplication sharedApplication].keyWindow;
    }
    return keyWindow;
}

// Method Swizzling 辅助方法
static void swizzleMethod(Class class, SEL originalSelector, SEL swizzledSelector) {
    Method originalMethod = class_getInstanceMethod(class, originalSelector);
    Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);
    
    BOOL didAddMethod = class_addMethod(class, originalSelector,
                                      method_getImplementation(swizzledMethod),
                                      method_getTypeEncoding(swizzledMethod));
    
    if (didAddMethod) {
        class_replaceMethod(class, swizzledSelector,
                          method_getImplementation(originalMethod),
                          method_getTypeEncoding(originalMethod));
    } else {
        method_exchangeImplementations(originalMethod, swizzledMethod);
    }
}

#pragma mark - FloatingButton 实现

@implementation FloatingButton

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        // 基本设置
        self.backgroundColor = [UIColor colorWithRed:0.4 green:0.8 blue:1.0 alpha:0.8];
        self.layer.cornerRadius = frame.size.width / 2;
        self.layer.masksToBounds = YES;
        [self setTitle:@"logo" forState:UIControlStateNormal];
        self.titleLabel.font = [UIFont systemFontOfSize:12];
        
        // 添加拖动手势
        UIPanGestureRecognizer *panGesture = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(handlePan:)];
        [self addGestureRecognizer:panGesture];
        
        // 添加长按手势
        UILongPressGestureRecognizer *longPressGesture = [[UILongPressGestureRecognizer alloc] initWithTarget:self action:@selector(handleLongPress:)];
        longPressGesture.minimumPressDuration = 0.5;
        [self addGestureRecognizer:longPressGesture];
    }
    return self;
}

// 处理拖动手势
- (void)handlePan:(UIPanGestureRecognizer *)gesture {
    CGPoint translation = [gesture translationInView:self.superview];
    CGPoint newCenter = CGPointMake(self.center.x + translation.x, self.center.y + translation.y);
    
    // 限制按钮在屏幕范围内
    newCenter.x = MAX(self.frame.size.width / 2, MIN(newCenter.x, self.superview.frame.size.width - self.frame.size.width / 2));
    newCenter.y = MAX(self.frame.size.height / 2, MIN(newCenter.y, self.superview.frame.size.height - self.frame.size.height / 2));
    
    self.center = newCenter;
    [gesture setTranslation:CGPointZero inView:self.superview];
}

// 处理长按手势
- (void)handleLongPress:(UILongPressGestureRecognizer *)gesture {
    if (gesture.state == UIGestureRecognizerStateBegan) {
        [self showControlPanel];
    }
}

// 显示控制面板
- (void)showControlPanel {
    if (!controlPanel) {
        CGFloat panelWidth = [UIScreen mainScreen].bounds.size.width * 0.8;
        CGFloat panelHeight = [UIScreen mainScreen].bounds.size.height * 0.4;
        CGRect frame = CGRectMake(([UIScreen mainScreen].bounds.size.width - panelWidth) / 2,
                                 ([UIScreen mainScreen].bounds.size.height - panelHeight) / 2,
                                 panelWidth,
                                 panelHeight);
        controlPanel = [[ControlPanel alloc] initWithFrame:frame];
    }
    
    // 添加动画效果
    controlPanel.alpha = 0;
    controlPanel.transform = CGAffineTransformMakeScale(0.1, 0.1);
    [getKeyWindow() addSubview:controlPanel];
    
    [UIView animateWithDuration:0.3 animations:^{
        controlPanel.alpha = 1;
        controlPanel.transform = CGAffineTransformIdentity;
    }];
}

// 设置Base64图片
- (void)setBase64Image:(NSString *)base64String {
    if (base64String) {
        NSData *imageData = [[NSData alloc] initWithBase64EncodedString:base64String options:NSDataBase64DecodingIgnoreUnknownCharacters];
        if (imageData) {
            UIImage *image = [UIImage imageWithData:imageData];
            if (image) {
                [self setImage:image forState:UIControlStateNormal];
                [self setTitle:@"" forState:UIControlStateNormal];
            }
        }
    }
}

@end

#pragma mark - ControlPanel 实现

@implementation ControlPanel

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        // 基本设置
        self.backgroundColor = [UIColor whiteColor];
        self.layer.cornerRadius = 15;
        self.layer.shadowColor = [UIColor blackColor].CGColor;
        self.layer.shadowOffset = CGSizeMake(0, 2);
        self.layer.shadowOpacity = 0.3;
        self.layer.shadowRadius = 4;
        self.clipsToBounds = NO;
        self.layer.masksToBounds = NO;
        
        [self setupUI];
    }
    return self;
}

// 设置UI界面
- (void)setupUI {
    // 标题
    UILabel *titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(20, 10, self.frame.size.width - 40, 30)];
    titleLabel.text = @"@c00kiec00k";
    titleLabel.textColor = [UIColor darkGrayColor];
    titleLabel.font = [UIFont systemFontOfSize:10];
    titleLabel.textAlignment = NSTextAlignmentLeft;
    [self addSubview:titleLabel];
    
    // 关闭按钮
    UIButton *closeButton = [UIButton buttonWithType:UIButtonTypeSystem];
    closeButton.frame = CGRectMake(self.frame.size.width - 40, 10, 30, 30);
    [closeButton setTitle:@"×" forState:UIControlStateNormal];
    [closeButton setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
    closeButton.titleLabel.font = [UIFont systemFontOfSize:12];
    [closeButton addTarget:self action:@selector(closePanel) forControlEvents:UIControlEventTouchUpInside];
    [self addSubview:closeButton];
    
    // 设置选项
    NSArray *options = @[
        @{@"title": @"去除底栏购物", @"key": @"remove_tab_shopping"},
        @{@"title": @"去除底栏加号", @"key": @"remove_tab_post"},
        @{@"title": @"去除保存水印", @"key": @"remove_save_watermark"},
        @{@"title": @"强制保存媒体", @"key": @"force_save_media"}
    ];
    
    CGFloat yOffset = 50;
    CGFloat itemHeight = 40;
    CGFloat padding = 10;
    
    // 创建选项列表
    for (NSInteger i = 0; i < [options count]; i++) {
        NSDictionary *option = options[i];
        
        // 选项标签
        UILabel *itemLabel = [[UILabel alloc] initWithFrame:CGRectMake(20, yOffset, self.frame.size.width - 80, itemHeight)];
        itemLabel.text = option[@"title"];
        itemLabel.textColor = [UIColor darkGrayColor];
        itemLabel.font = [UIFont systemFontOfSize:14];
        [self addSubview:itemLabel];
        
        // 开关控件
        UISwitch *switchView = [[UISwitch alloc] initWithFrame:CGRectMake(self.frame.size.width - 70, yOffset + 5, 51, 31)];
        switchView.on = [[NSUserDefaults standardUserDefaults] boolForKey:option[@"key"]];
        [switchView addTarget:self action:@selector(switchChanged:) forControlEvents:UIControlEventValueChanged];
        switchView.tag = i;
        [self addSubview:switchView];
        
        yOffset += itemHeight + padding;
    }
}

// 处理开关状态变化
- (void)switchChanged:(UISwitch *)sender {
    NSArray *keys = @[@"remove_tab_shopping", @"remove_tab_post", @"remove_save_watermark", @"force_save_media"];
    NSString *key = keys[sender.tag];
    [[NSUserDefaults standardUserDefaults] setBool:sender.isOn forKey:key];
    [[NSUserDefaults standardUserDefaults] synchronize];
}

// 关闭面板
- (void)closePanel {
    [UIView animateWithDuration:0.3 animations:^{
        self.alpha = 0;
        self.transform = CGAffineTransformMakeScale(0.1, 0.1);
    } completion:^(BOOL finished) {
        [self removeFromSuperview];
    }];
}

@end

#pragma mark - Hook实现

// AppDelegate Hook
@implementation XHSAppDelegate (XhsPlus)

+ (void)load {
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        Class class = [self class];
        swizzleMethod(class,
                     @selector(application:didFinishLaunchingWithOptions:),
                     @selector(xhsplus_application:didFinishLaunchingWithOptions:));
    });
}

- (BOOL)xhsplus_application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    BOOL result = [self xhsplus_application:application didFinishLaunchingWithOptions:launchOptions];
    
    // 延迟初始化UI，确保window已经创建
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        // 创建悬浮按钮
        CGFloat screenWidth = [UIScreen mainScreen].bounds.size.width;
        CGFloat screenHeight = [UIScreen mainScreen].bounds.size.height;
        
        floatingButton = [[FloatingButton alloc] initWithFrame:CGRectMake(
            (screenWidth - 40) / 2,
            (screenHeight - 40) / 2,
            40,
            40
        )];
        [getKeyWindow() addSubview:floatingButton];
        
        // 添加三指双击手势
        UITapGestureRecognizer *multiTapGesture = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(handleMultiTap:)];
        multiTapGesture.numberOfTouchesRequired = 3;
        multiTapGesture.numberOfTapsRequired = 2;
        [getKeyWindow() addGestureRecognizer:multiTapGesture];
    });
    
    return result;
}

// 处理三指双击手势
- (void)handleMultiTap:(UITapGestureRecognizer *)gesture {
    isButtonVisible = !isButtonVisible;
    [UIView animateWithDuration:0.3 animations:^{
        floatingButton.alpha = isButtonVisible ? 1.0 : 0.0;
    }];
}

@end

// 底部标签栏Hook
@implementation XYTabBar (XhsPlus)

+ (void)load {
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        Class class = [self class];
        swizzleMethod(class,
                     @selector(layoutSubviews),
                     @selector(xhsplus_layoutSubviews));
    });
}

- (void)xhsplus_layoutSubviews {
    [self xhsplus_layoutSubviews];
    
    // 处理底部标签栏
    if (self.subviews.count >= 3) {
        BOOL removeShoppingTab = [[NSUserDefaults standardUserDefaults] boolForKey:@"remove_tab_shopping"];
        BOOL removePostTab = [[NSUserDefaults standardUserDefaults] boolForKey:@"remove_tab_post"];
        
        if (removeShoppingTab && removePostTab) {
            [[self.subviews objectAtIndex:1] removeFromSuperview];
            [[self.subviews objectAtIndex:1] removeFromSuperview];
        } else {
            if (removeShoppingTab) {
                [[self.subviews objectAtIndex:1] removeFromSuperview];
            }
            if (removePostTab) {
                [[self.subviews objectAtIndex:2] removeFromSuperview];
            }
        }
    }

    // 重新布局剩余标签
    CGFloat tabWidth = CGRectGetWidth(self.bounds) / self.subviews.count;
    CGFloat xPosition = 0;
    
    for (UIView *subview in self.subviews) {
        CGRect frame = subview.frame;
        frame.origin.x = xPosition;
        frame.size.width = tabWidth;
        subview.frame = frame;
        
        xPosition += tabWidth;
    }
}

@end

// 媒体保存配置Hook
@implementation XYPHMediaSaveConfig (XhsPlus)

+ (void)load {
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        Class class = [self class];
        swizzleMethod(class,
                     @selector(setDisableWatermark:),
                     @selector(xhsplus_setDisableWatermark:));
        swizzleMethod(class,
                     @selector(setDisableSave:),
                     @selector(xhsplus_setDisableSave:));
    });
}

- (void)xhsplus_setDisableWatermark:(_Bool)arg1 {
    BOOL removeWatermark = [[NSUserDefaults standardUserDefaults] boolForKey:@"remove_save_watermark"];
    [self xhsplus_setDisableWatermark:removeWatermark];
}

- (void)xhsplus_setDisableSave:(_Bool)arg1 {
    BOOL forceSaveMedia = [[NSUserDefaults standardUserDefaults] boolForKey:@"force_save_media"];
    if (forceSaveMedia) {
        [self xhsplus_setDisableSave:NO];
    } else {
        [self xhsplus_setDisableSave:arg1];
    }
}

@end
